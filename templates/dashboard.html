<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Segmentaci칩n Inteligente</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        /* Ajustes espec칤ficos para posicionar contenido debajo del navbar */
        body {
            padding-top: 60px; /* Altura del navbar fijo */
        }
        
        .navbar {
            min-height: 60px;
        }
        
        .main-content {
            margin-top: 0;
            padding-top: 0;
        }
        
        /* Asegurar que el contenido no quede oculto detr치s del navbar */
        .container {
            padding-top: 1rem;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-chart-pie me-2"></i>
                Segmentaci칩n Inteligente
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">Inicio</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/dashboard">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/predict">Predecir</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/analysis">An치lisis</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content - Comienza justo debajo del navbar -->
    <div class="main-content">
        <div class="container">
            <!-- Dashboard Header Compacto -->
            <div class="page-header text-center mb-4">
                <h1 class="page-title dashboard-title">
                    <i class="fas fa-dashboard"></i>
                    Dashboard Interactivo
                </h1>
                <p class="page-subtitle">
                    Visualizaci칩n y an치lisis en tiempo real de segmentos de clientes
                </p>
            </div>

            <!-- Stats Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-white bg-primary shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h2 class="card-title fw-bold">{{ stats.total_clientes }}</h2>
                                    <p class="card-text mb-0">Total Clientes</p>
                                </div>
                                <div class="display-6">
                                    <i class="fas fa-users"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-success shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h2 class="card-title fw-bold">{{ stats.total_segmentos }}</h2>
                                    <p class="card-text mb-0">Segmentos</p>
                                </div>
                                <div class="display-6">
                                    <i class="fas fa-chart-pie"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-warning shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h2 class="card-title fw-bold">{{ stats.segmento_mayor }}</h2>
                                    <p class="card-text mb-0">Segmento Mayor</p>
                                </div>
                                <div class="display-6">
                                    <i class="fas fa-arrow-up"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-white bg-info shadow-sm">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <h2 class="card-title fw-bold">{{ stats.segmento_menor }}</h2>
                                    <p class="card-text mb-0">Segmento Menor</p>
                                </div>
                                <div class="display-6">
                                    <i class="fas fa-arrow-down"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="row">
                <!-- Distribution Chart -->
                <div class="col-lg-6 mb-4">
                    <div class="card shadow-sm h-100">
                        <div class="card-header bg-primary text-white">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-chart-pie me-2"></i>
                                Distribuci칩n de Segmentos
                            </h5>
                        </div>
                        <div class="card-body d-flex align-items-center justify-content-center">
                            {% if graph1_html %}
                                <div class="plotly-chart w-100">
                                    {{ graph1_html|safe }}
                                </div>
                            {% else %}
                                <div class="alert alert-warning text-center w-100">
                                    <i class="fas fa-exclamation-triangle fa-2x mb-3 d-block"></i>
                                    <h6>Datos no disponibles</h6>
                                    <p class="mb-0">No hay datos para el gr치fico de distribuci칩n</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- PCA Scatter Chart -->
                <div class="col-lg-6 mb-4">
                    <div class="card shadow-sm h-100">
                        <div class="card-header bg-success text-white">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-braille me-2"></i>
                                Visualizaci칩n de Segmentos - PCA
                            </h5>
                        </div>
                        <div class="card-body d-flex align-items-center justify-content-center">
                            {% if graph2_html %}
                                <div class="plotly-chart w-100">
                                    {{ graph2_html|safe }}
                                </div>
                            {% else %}
                                <div class="alert alert-warning text-center w-100">
                                    <i class="fas fa-exclamation-triangle fa-2x mb-3 d-block"></i>
                                    <h6>Datos no disponibles</h6>
                                    <p class="mb-0">No hay datos de PCA para visualizaci칩n</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Additional Visualizations -->
            <div class="row">
                <!-- Demographic Analysis -->
                <div class="col-lg-6 mb-4">
                    <div class="card shadow-sm h-100">
                        <div class="card-header bg-info text-white">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-user-friends me-2"></i>
                                An치lisis Demogr치fico por Segmento
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Segmento</th>
                                            <th>Clientes</th>
                                            {% if 'Age' in df_clustered.columns %}
                                            <th>Edad Prom.</th>
                                            {% endif %}
                                            {% if 'Income Level' in df_clustered.columns %}
                                            <th>Ingreso Prom.</th>
                                            {% endif %}
                                            {% if 'Premium Amount' in df_clustered.columns %}
                                            <th>Prima Prom.</th>
                                            {% endif %}
                                            {% if 'Coverage Amount' in df_clustered.columns %}
                                            <th>Cobertura Prom.</th>
                                            {% endif %}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for cluster_num, cluster_name in cluster_names.items() %}
                                        {% set segment_data = df_clustered[df_clustered['Cluster'] == cluster_num] %}
                                        <tr>
                                            <td><strong>{{ cluster_name }}</strong></td>
                                            <td><span class="badge bg-primary rounded-pill">{{ segment_data|length }}</span></td>
                                            {% if 'Age' in df_clustered.columns %}
                                            <td>{{ "%.1f"|format(segment_data['Age'].mean()) }} a침os</td>
                                            {% endif %}
                                            {% if 'Income Level' in df_clustered.columns %}
                                            <td>${{ "%.1f"|format(segment_data['Income Level'].mean()) }}</td>
                                            {% endif %}
                                            {% if 'Premium Amount' in df_clustered.columns %}
                                            <td>${{ "%.1f"|format(segment_data['Premium Amount'].mean()) }}</td>
                                            {% endif %}
                                            {% if 'Coverage Amount' in df_clustered.columns %}
                                            <td>${{ "%.1f"|format(segment_data['Coverage Amount'].mean()) }}</td>
                                            {% endif %}
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="col-lg-6 mb-4">
                    <div class="card shadow-sm h-100">
                        <div class="card-header bg-warning text-white">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-rocket me-2"></i>
                                Acciones R치pidas
                            </h5>
                        </div>
                        <div class="card-body quick-actions">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <a href="/predict" class="btn btn-primary">
                                        <i class="fas fa-magic"></i>
                                        <br>
                                        Predecir Segmento
                                    </a>
                                </div>
                                <div class="col-md-6">
                                    <a href="/analysis" class="btn btn-success">
                                        <i class="fas fa-chart-bar"></i>
                                        <br>
                                        An치lisis Detallado
                                    </a>
                                </div>
                                <div class="col-md-6">
                                    <a href="/download/report" class="btn btn-info">
                                        <i class="fas fa-download"></i>
                                        <br>
                                        Descargar Reporte
                                    </a>
                                </div>
                                <div class="col-md-6">
                                    <a href="/debug" class="btn btn-secondary">
                                        <i class="fas fa-bug"></i>
                                        <br>
                                        Ver Debug
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Model Information -->
            <div class="row">
                <div class="col-12">
                    <div class="card shadow-sm">
                        <div class="card-header bg-dark text-white">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-info-circle me-2"></i>
                                Informaci칩n del Modelo
                            </h5>
                        </div>
                        <div class="card-body model-info">
                            <div class="row">
                                <div class="col-md-3 text-center">
                                    <h6>游뱄 Algoritmo</h6>
                                    <p class="text-muted">K-Means Clustering</p>
                                </div>
                                <div class="col-md-3 text-center">
                                    <h6>游댢 Preprocesamiento</h6>
                                    <p class="text-muted">StandardScaler + PCA</p>
                                </div>
                                <div class="col-md-3 text-center">
                                    <h6>游늵 Variables</h6>
                                    <p class="text-muted">
                                        {% if feature_names %}
                                            {{ feature_names|length }} caracter칤sticas
                                        {% else %}
                                            No disponible
                                        {% endif %}
                                    </p>
                                </div>
                                <div class="col-md-3 text-center">
                                    <h6>游꿢 Segmentos</h6>
                                    <p class="text-muted">
                                        {% if cluster_names %}
                                            {{ cluster_names|length }} segmentos
                                        {% else %}
                                            No disponible
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-white py-4 mt-5">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h5 class="mb-3">
                        <i class="fas fa-chart-pie me-2"></i>Segmentaci칩n Inteligente
                    </h5>
                    <p class="text-muted mb-0">
                        Dashboard interactivo para an치lisis avanzado de segmentos de clientes.
                    </p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p class="text-muted mb-0">
                        &copy; 2025 Proyecto CRISP-DM. Todos los derechos reservados.
                    </p>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- JavaScript para el Navbar y funcionalidades -->
    <script>
        // Script para el comportamiento del navbar
        document.addEventListener('DOMContentLoaded', function() {
            const navbar = document.querySelector('.navbar');
            
            // Scroll behavior para navbar compacto
            window.addEventListener('scroll', function() {
                if (window.scrollY > 50) {
                    navbar.classList.add('scrolled', 'compact-nav', 'small-header');
                } else {
                    navbar.classList.remove('scrolled', 'compact-nav', 'small-header');
                }
            });

            // A침adir clase enhanced-title a todos los t칤tulos de p치gina
            const pageTitles = document.querySelectorAll('.page-title, .display-4, .display-5');
            pageTitles.forEach(title => {
                title.classList.add('enhanced-title');
            });

            // Smooth scroll para enlaces internos
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    const target = document.querySelector(this.getAttribute('href'));
                    if (target) {
                        target.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                    }
                });
            });

            // Cerrar navbar m칩vil al hacer clic en un enlace
            const navLinks = document.querySelectorAll('.nav-link');
            const navbarToggler = document.querySelector('.navbar-toggler');
            const navbarCollapse = document.querySelector('.navbar-collapse');
            
            navLinks.forEach(link => {
                link.addEventListener('click', () => {
                    if (navbarCollapse.classList.contains('show')) {
                        navbarToggler.click();
                    }
                });
            });

            // Enhance plotly charts
            setTimeout(() => {
                const plots = document.querySelectorAll('.js-plotly-plot');
                plots.forEach(plot => {
                    plot.style.borderRadius = '10px';
                    plot.style.overflow = 'hidden';
                });
            }, 100);

            console.log('Dashboard interactivo cargado correctamente');
        });

        function refreshDashboard() {
            const refreshBtn = document.createElement('button');
            refreshBtn.className = 'btn btn-primary position-fixed';
            refreshBtn.style.bottom = '20px';
            refreshBtn.style.right = '20px';
            refreshBtn.style.zIndex = '1000';
            refreshBtn.innerHTML = '<i class="fas fa-sync-alt me-2"></i>Actualizar';
            refreshBtn.onclick = () => window.location.reload();
            document.body.appendChild(refreshBtn);
        }

        // Auto-refresh cada 5 minutos
        setTimeout(() => {
            refreshDashboard();
        }, 1000);

        // Mostrar notificaci칩n de actualizaci칩n autom치tica
        setTimeout(() => {
            if (document.querySelector('.toast') === null) {
                const toast = document.createElement('div');
                toast.className = 'toast align-items-center text-white bg-primary border-0 position-fixed';
                toast.style.bottom = '20px';
                toast.style.left = '20px';
                toast.style.zIndex = '1000';
                toast.innerHTML = `
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="fas fa-info-circle me-2"></i>
                            El dashboard se actualiza autom치ticamente cada 5 minutos
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                    </div>
                `;
                document.body.appendChild(toast);
                new bootstrap.Toast(toast).show();
            }
        }, 5000);
    </script>
</body>
</html>